version: '3.8'

services:

  # ── Infrastructure ─────────────────────────────────────────
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 15

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      interval: 10s
      timeout: 10s
      retries: 20
      start_period: 30s

  mongo:
    image: mongo:6.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 15

  redis:
    image: redis:7.2
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 15

  # ── Application services ───────────────────────────────────
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    ports:
      - "8000:8000"
    environment:
      MONGO_URI: mongodb://mongo:27017
      REDIS_URI: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: on-failure

  # Worker א' – "המטבח" (Part 1: worker_kitchen)
  worker_kitchen:
    build:
      context: .
      dockerfile: Dockerfile.workers
    command: python kitchen_worker.py
    environment:
      MONGO_URI: mongodb://mongo:27017
      REDIS_URI: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: on-failure

  # Worker ב' – "מעבד הטקסט" (Part 1 - original, before split)
  text_worker:
    build:
      context: .
      dockerfile: Dockerfile.workers
    command: python text_worker.py
    environment:
      MONGO_URI: mongodb://mongo:27017
      REDIS_URI: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: on-failure

  # Worker ב' חלק א' – Preprocessor "מעבד הבצק" (Part 2)
  preprocessor:
    build:
      context: .
      dockerfile: Dockerfile.workers
    command: python preprocessor.py
    environment:
      MONGO_URI: mongodb://mongo:27017
      REDIS_URI: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: on-failure

  # Worker ב' חלק ב' – Enricher "מומחה התוספות" (Part 2)
  enricher:
    build:
      context: .
      dockerfile: Dockerfile.workers
    command: python enricher.py
    environment:
      MONGO_URI: mongodb://mongo:27017
      REDIS_URI: redis://redis:6379
      KAFKA_BOOTSTRAP: kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
      mongo:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: on-failure

  # ── Part 3 Services ────────────────────────────────────────

  # Risk Evaluator – "קצין סיכונים" (Part 3)
  risk_evaluator:
    build:
      context: .
      dockerfile: Dockerfile.workers
    command: python risk_evaluator.py
    environment:
      MONGO_URI: mongodb://mongo:27017
      SCAN_INTERVAL: "10"  # seconds between scans
    depends_on:
      mongo:
        condition: service_healthy
    restart: on-failure

  # Streamlit Dashboard (Part 3)
  streamlit_dashboard:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    ports:
      - "8501:8501"
    environment:
      MONGO_URI: mongodb://mongo:27017
    depends_on:
      mongo:
        condition: service_healthy
    restart: on-failure

volumes:
  mongo_data:
